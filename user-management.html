<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Growth Manager Pro</title>
    <script src="/auth.js"></script>
    <script src="/nav.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        
        .header { margin-bottom: 2rem; }
        .header h1 { color: #2c3e50; font-size: 2rem; margin-bottom: 0.5rem; }
        .header p { color: #7f8c8d; }
        
        .action-bar { display: flex; gap: 1rem; margin-bottom: 2rem; }
        .btn { padding: 0.8rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.95rem; }
        .btn-primary { background: #3498db; color: white; }
        .btn:hover { opacity: 0.9; }
        
        .users-section { background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        .users-table { width: 100%; border-collapse: collapse; }
        .users-table th { background: #f8f9fa; padding: 1rem; text-align: left; color: #2c3e50; font-weight: 600; border-bottom: 2px solid #e1e5e9; }
        .users-table td { padding: 1rem; border-bottom: 1px solid #e1e5e9; }
        
        .role-badge { padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; display: inline-block; }
        .role-badge.admin { background: #e74c3c; color: white; }
        .role-badge.advisor { background: #3498db; color: white; }
        
        .action-buttons { display: flex; gap: 0.5rem; }
        .action-btn { padding: 0.5rem 1rem; border: 1px solid #e1e5e9; background: white; border-radius: 6px; font-size: 0.85rem; cursor: pointer; }
        .action-btn:hover { background: #f8f9fa; }
        .action-btn.delete { color: #e74c3c; border-color: #e74c3c; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 12px; padding: 2rem; max-width: 500px; width: 90%; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-header h2 { color: #2c3e50; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #7f8c8d; }
        
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; color: #2c3e50; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 0.8rem; border: 1px solid #e1e5e9; border-radius: 6px; font-size: 1rem; }
        
        .empty-state { text-align: center; padding: 3rem; color: #7f8c8d; }
        
        .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 0.5rem; }
        .status-dot.active { background: #27ae60; }
        .status-dot.inactive { background: #95a5a6; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚙️ User Management</h1>
            <p>Manage users and permissions</p>
        </div>

        <div class="action-bar">
            <button class="btn btn-primary" onclick="openAddUserModal()">+ Add User</button>
        </div>

        <div class="users-section">
            <table class="users-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Last Login</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr>
                        <td colspan="5" class="empty-state">Loading users...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal" id="addUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New User</h2>
                <button class="close-btn" onclick="closeModal('addUserModal')">&times;</button>
            </div>
            <form onsubmit="addUser(event)">
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="fullName" required>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label>Password *</label>
                    <input type="password" id="password" required minlength="6">
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="role">
                        <option value="advisor">Advisor (View Only)</option>
                        <option value="admin">Admin (Full Access)</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Add User</button>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal" id="editUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit User</h2>
                <button class="close-btn" onclick="closeModal('editUserModal')">&times;</button>
            </div>
            <form onsubmit="updateUser(event)">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="editFullName" required>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="editEmail" required>
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="editRole">
                        <option value="advisor">Advisor (View Only)</option>
                        <option value="admin">Admin (Full Access)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>New Password (leave blank to keep current)</label>
                    <input type="password" id="editPassword" minlength="6">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Update User</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'https://growthmanagerpro-backend.vercel.app';
        let currentUser = JSON.parse(localStorage.getItem('user'));

        async function loadUsers() {
            try {
                const response = await fetch(`${API_URL}/api/users`);
                const result = await response.json();
                
                if (!result.success) throw new Error(result.error);
                
                const users = result.data || [];
                renderUsers(users);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('usersTableBody').innerHTML = 
                    '<tr><td colspan="5" class="empty-state">Error loading users</td></tr>';
            }
        }

        function renderUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No users found</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>
                        <span class="status-dot ${user.last_login ? 'active' : 'inactive'}"></span>
                        ${user.full_name}
                    </td>
                    <td>${user.email}</td>
                    <td>
                        <span class="role-badge ${user.role}">${user.role}</span>
                    </td>
                    <td>${user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn" onclick="openEditUserModal('${user.id}')">Edit</button>
                            ${user.id !== currentUser.id ? `<button class="action-btn delete" onclick="deleteUser('${user.id}')">Delete</button>` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function openAddUserModal() {
            document.getElementById('addUserModal').classList.add('show');
        }

        function openEditUserModal(userId) {
            // Fetch user data and populate form
            fetch(`${API_URL}/api/users/${userId}`)
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        const user = result.data;
                        document.getElementById('editUserId').value = user.id;
                        document.getElementById('editFullName').value = user.full_name;
                        document.getElementById('editEmail').value = user.email;
                        document.getElementById('editRole').value = user.role;
                        document.getElementById('editUserModal').classList.add('show');
                    }
                })
                .catch(error => alert('Error loading user: ' + error.message));
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        async function addUser(event) {
            event.preventDefault();
            
            const data = {
                full_name: document.getElementById('fullName').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                role: document.getElementById('role').value
            };
            
            try {
                const response = await fetch(`${API_URL}/api/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (!result.success) throw new Error(result.error);
                
                closeModal('addUserModal');
                loadUsers();
                alert('User added successfully!');
                
                // Reset form
                event.target.reset();
            } catch (error) {
                console.error('Error:', error);
                alert('Error adding user: ' + error.message);
            }
        }

        async function updateUser(event) {
            event.preventDefault();
            
            const userId = document.getElementById('editUserId').value;
            const data = {
                full_name: document.getElementById('editFullName').value,
                email: document.getElementById('editEmail').value,
                role: document.getElementById('editRole').value
            };
            
            const newPassword = document.getElementById('editPassword').value;
            if (newPassword) {
                data.password = newPassword;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (!result.success) throw new Error(result.error);
                
                closeModal('editUserModal');
                loadUsers();
                alert('User updated successfully!');
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating user: ' + error.message);
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;
            
            try {
                const response = await fetch(`${API_URL}/api/users/${userId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (!result.success) throw new Error(result.error);
                
                loadUsers();
                alert('User deleted successfully!');
            } catch (error) {
                console.error('Error:', error);
                alert('Error deleting user: ' + error.message);
            }
        }

        // Load users on page load
        document.addEventListener('DOMContentLoaded', loadUsers);
    </script>
</body>
</html>
