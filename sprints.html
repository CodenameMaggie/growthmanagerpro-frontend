<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Tasks & Clients</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            min-height: 100vh;
            color: #333;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 280px;
            background: white;
            padding: 2rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            left: 0;
            top: 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .sidebar-header {
            padding: 0 2rem 2rem 2rem;
            border-bottom: 2px solid #e1e5e9;
            margin-bottom: 2rem;
        }

        .sidebar-header h1 {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .sidebar-header p {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-section-title {
            padding: 0 2rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: #95a5a6;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.8rem 2rem;
            color: #5a6c7d;
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
        }

        .nav-item:hover {
            background: #f8f9fa;
            color: #2c3e50;
        }

        .nav-item.active {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            font-weight: 600;
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #2980b9;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            min-width: 20px;
            margin-right: 1rem;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-item-content {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .nav-item-text {
            display: flex;
            align-items: center;
        }

        .notification-badge {
            background: #e74c3c;
            color: white;
            padding: 0.25rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            min-width: 22px;
            text-align: center;
            margin-left: 0.5rem;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
        }

        /* Page Header */
        .page-header {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .page-header h2 {
            font-size: 2rem;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: #7f8c8d;
            font-size: 1rem;
        }

        /* Section Container */
        .section-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .section-header {
            padding: 1.5rem 2rem;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h3 {
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section-body {
            padding: 2rem;
        }

        /* Action Items Section */
        .action-category {
            margin-bottom: 2rem;
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #e1e5e9;
        }

        .category-icon {
            font-size: 1.5rem;
        }

        .category-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            flex: 1;
        }

        .category-count {
            background: #3498db;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .task-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .task-item:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }

        .task-item.completed {
            opacity: 0.6;
            background: #f8f9fa;
        }

        .task-checkbox {
            width: 24px;
            height: 24px;
            min-width: 24px;
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 0.25rem;
        }

        .task-item:hover .task-checkbox {
            border-color: #3498db;
        }

        .task-checkbox.checked {
            background: linear-gradient(135deg, #27ae60, #229954);
            border-color: #27ae60;
            color: white;
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-size: 1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .task-item.completed .task-title {
            text-decoration: line-through;
            color: #95a5a6;
        }

        .task-details {
            font-size: 0.9rem;
            color: #7f8c8d;
            line-height: 1.5;
        }

        .task-meta {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: #95a5a6;
        }

        .task-meta span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .empty-category {
            text-align: center;
            padding: 2rem;
            color: #7f8c8d;
            font-style: italic;
        }

        /* Client Communication Section */
        .client-tabs {
            display: flex;
            gap: 0.5rem;
            padding: 1.5rem 2rem 0 2rem;
            background: white;
            overflow-x: auto;
            border-bottom: 2px solid #e1e5e9;
        }

        .client-tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #7f8c8d;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
        }

        .client-tab:hover {
            color: #2c3e50;
            background: #f8f9fa;
        }

        .client-tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        .client-tab-badge {
            background: #e74c3c;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }

        .client-tab.active .client-tab-badge {
            background: #3498db;
        }

        .attention-indicator {
            width: 8px;
            height: 8px;
            background: #e74c3c;
            border-radius: 50%;
            position: absolute;
            top: 8px;
            right: 8px;
            animation: pulse-attention 2s infinite;
        }

        @keyframes pulse-attention {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.2);
            }
        }

        .client-content {
            display: none;
            padding: 2rem;
        }

        .client-content.active {
            display: block;
        }

        .client-info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .client-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .client-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.25rem;
        }

        .client-details h4 {
            font-size: 1.1rem;
            color: #2c3e50;
            margin-bottom: 0.25rem;
        }

        .client-details p {
            font-size: 0.85rem;
            color: #7f8c8d;
        }

        .client-status {
            padding: 0.5rem 1rem;
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 20px;
            font-size: 0.85rem;
            color: #7f8c8d;
            font-weight: 600;
        }

        /* Message Thread */
        .message-thread {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .message {
            margin-bottom: 1.5rem;
            display: flex;
            gap: 1rem;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            min-width: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            color: white;
        }

        .message.from-client .message-avatar {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

        .message.from-you .message-avatar {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .message-content {
            flex: 1;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .message-author {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95rem;
        }

        .message-time {
            font-size: 0.8rem;
            color: #95a5a6;
        }

        .message-text {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            color: #5a6c7d;
            font-size: 0.95rem;
            line-height: 1.5;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .message-attachments {
            margin-top: 0.75rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .attachment {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: #e8f4f8;
            border: 1px solid #3498db;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #3498db;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .attachment:hover {
            background: #3498db;
            color: white;
        }

        /* Message Input */
        .message-input-container {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        .message-input {
            flex: 1;
            padding: 1rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95rem;
            resize: vertical;
            min-height: 80px;
        }

        .message-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .message-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        /* Button Styles */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: white;
            color: #3498db;
            border: 2px solid #3498db;
        }

        .btn-secondary:hover {
            background: #3498db;
            color: white;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .btn-icon {
            padding: 0.75rem;
            background: transparent;
            color: #7f8c8d;
            border: 2px solid #e1e5e9;
        }

        .btn-icon:hover {
            border-color: #3498db;
            color: #3498db;
            transform: none;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: #7f8c8d;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            font-size: 0.95rem;
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            z-index: 1000;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse-status 2s infinite;
        }

        .status-connected {
            background: #27ae60;
        }

        @keyframes pulse-status {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #7f8c8d;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e1e5e9;
            border-top-color: #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
            }

            .client-tabs {
                overflow-x: scroll;
            }

            .message-input-container {
                flex-direction: column;
            }

            .message-actions {
                flex-direction: row;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>Growth Manager Pro</h1>
                <p>Admin Workspace</p>
            </div>

            <nav>
                <div class="nav-section">
                    <div class="nav-section-title">Navigation</div>
                    <a href="dashboard.html" class="nav-item">
                        <div class="nav-item-content">
                            <span class="nav-icon">üìä</span>
                            <span class="nav-item-text">Dashboard</span>
                        </div>
                    </a>
                    <a href="sprints.html" class="nav-item active">
                        <div class="nav-item-content">
                            <span class="nav-icon">‚úÖ</span>
                            <span class="nav-item-text">My Tasks</span>
                        </div>
                        <span class="notification-badge" id="tasks-badge">5</span>
                    </a>
                   <a href="client-dashboard.html" class="nav-item">
    <div class="nav-item-content">
        <span class="nav-icon">üë§</span>
        <span class="nav-item-text">Client Dashboard</span>
    </div>
</a>
<a href="advisor-dashboard.html" class="nav-item">
    <div class="nav-item-content">
        <span class="nav-icon">üéØ</span>
        <span class="nav-item-text">Advisor Dashboard</span>
    </div>
</a>
</div>
<div class="nav-section">
    <div class="nav-section-title">System</div>
    <a href="pipeline.html" class="nav-item">
        <div class="nav-item-content">
            <span class="nav-icon">üíº</span>
            <span class="nav-item-text">Pipeline</span>
        </div>
    </a>
                    <a href="user-management.html" class="nav-item">
                        <div class="nav-item-content">
                            <span class="nav-icon">‚öôÔ∏è</span>
                            <span class="nav-item-text">Users</span>
                        </div>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Account</div>
                    <a href="login.html" class="nav-item">
                        <div class="nav-item-content">
                            <span class="nav-icon">üö™</span>
                            <span class="nav-item-text">Logout</span>
                        </div>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page Header -->
            <div class="page-header">
                <h2>My Tasks & Client Workspace</h2>
                <p class="page-subtitle">Action items needing your attention and private client communication</p>
            </div>

            <!-- Section 1: Action Items -->
            <div class="section-container">
                <div class="section-header">
                    <h3>
                        <span>üéØ</span>
                        <span>Action Items</span>
                    </h3>
                    <button class="btn btn-secondary btn-small" onclick="refreshTasks()">üîÑ Refresh</button>
                </div>
                <div class="section-body">
                    <!-- Podcast Exceptions -->
                    <div class="action-category">
                        <div class="category-header">
                            <span class="category-icon">üéôÔ∏è</span>
                            <span class="category-title">Podcast Exceptions</span>
                            <span class="category-count" id="podcast-count">0</span>
                        </div>
                        <div class="task-list" id="podcast-tasks">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                <p>Loading tasks...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Post-Discovery Actions -->
                    <div class="action-category">
                        <div class="category-header">
                            <span class="category-icon">üìû</span>
                            <span class="category-title">Post-Discovery Actions</span>
                            <span class="category-count" id="discovery-count">0</span>
                        </div>
                        <div class="task-list" id="discovery-tasks">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                <p>Loading tasks...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Post-Strategy Actions -->
                    <div class="action-category">
                        <div class="category-header">
                            <span class="category-icon">üíº</span>
                            <span class="category-title">Post-Strategy Actions</span>
                            <span class="category-count" id="strategy-count">0</span>
                        </div>
                        <div class="task-list" id="strategy-tasks">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                <p>Loading tasks...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Client To-Dos -->
                    <div class="action-category">
                        <div class="category-header">
                            <span class="category-icon">üë•</span>
                            <span class="category-title">Client To-Dos</span>
                            <span class="category-count" id="client-count">0</span>
                        </div>
                        <div class="task-list" id="client-tasks">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                <p>Loading tasks...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 2: Client Communication Hub -->
            <div class="section-container">
                <div class="section-header">
                    <h3>
                        <span>üí¨</span>
                        <span>Client Communication Hub</span>
                    </h3>
                    <button class="btn btn-secondary btn-small" onclick="refreshMessages()">üîÑ Refresh</button>
                </div>
                
                <!-- Client Tabs -->
                <div class="client-tabs" id="client-tabs">
                    <!-- Tabs will be dynamically generated -->
                </div>

                <!-- Client Content Areas -->
                <div id="client-contents">
                    <!-- Content will be dynamically generated -->
                </div>
            </div>
        </main>

        <!-- Connection Status -->
        <div class="connection-status">
            <div class="status-indicator status-connected" id="status-indicator"></div>
            <span id="status-text">Live Connected</span>
        </div>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="file-input" style="display: none;" onchange="handleFileUpload()">

   
<script src="auth-helper.js"></script>
    
<script>
    (function() {
        if (!AuthHelper.protectPage('advisor-dashboard.html')) {  // ‚Üê NOW CORRECT
            throw new Error('Unauthorized access');
        }
        AuthHelper.applyPermissions();
    })();
    
    const API_URL = 'https://growthmanagerpro-backend.vercel.app';
        
        // Data stores
        let tasksData = {
            podcast: [],
            discovery: [],
            strategy: [],
            client: []
        };
        
        let clientsData = [];
        let messagesData = {};
        let activeClientId = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[Sprints] Initializing...');
            loadAllData();
            
            // Auto-refresh every 2 minutes
            setInterval(loadAllData, 2 * 60 * 1000);
        });

        async function loadAllData() {
            try {
                await Promise.all([
                    loadTasks(),
                    loadClients(),
                    loadMessages()
                ]);
                updateTaskBadge();
            } catch (error) {
                console.error('[Sprints] Error loading data:', error);
                // Load demo data
                loadDemoData();
            }
        }

        async function loadTasks() {
            try {
                const response = await fetch(`${API_URL}/api/sprints/action-items`);
                if (!response.ok) throw new Error('Failed to load tasks');
                
                const result = await response.json();
                tasksData = result.tasks || tasksData;
                renderAllTasks();
            } catch (error) {
                console.error('[Sprints] Error loading tasks:', error);
                loadDemoTasks();
            }
        }

        function loadDemoTasks() {
            tasksData = {
                podcast: [
                    {
                        id: 'p1',
                        title: 'Sarah Johnson - Score 28, Requested Discovery',
                        details: 'Despite low score, prospect is very interested. Review recording to assess fit.',
                        date: '2 hours ago',
                        completed: false
                    }
                ],
                discovery: [
                    {
                        id: 'd1',
                        title: 'Create Growth Plan for Jonathan (Brewer & Company)',
                        details: 'Discovery call completed Oct 23. Prospect agreed to see offer. Build custom 7x ROI strategy.',
                        date: 'Yesterday',
                        client: 'Jonathan Brewer',
                        completed: false
                    },
                    {
                        id: 'd2',
                        title: 'Prepare Strategy Call for Tye (TWS Construction)',
                        details: 'Discovery went great! Build custom proposal focusing on contractor lead generation.',
                        date: '2 days ago',
                        client: 'Tye Shumway',
                        completed: false
                    }
                ],
                strategy: [
                    {
                        id: 's1',
                        title: 'Onboard New Client: Sarah (Design Co)',
                        details: 'Contract signed Oct 24. Set up in systems, send welcome materials, schedule kickoff.',
                        date: 'Today',
                        client: 'Sarah',
                        completed: false
                    }
                ],
                client: [
                    {
                        id: 'c1',
                        title: 'Weekly Check-in with Jonathan',
                        details: 'Review progress, discuss Q4 goals, address any blockers.',
                        date: 'Tomorrow',
                        client: 'Jonathan Brewer',
                        completed: false
                    },
                    {
                        id: 'c2',
                        title: 'Review Q4 Results with Tye',
                        details: 'Scheduled for Friday. Prepare performance report and recommendations.',
                        date: 'Friday',
                        client: 'Tye Shumway',
                        completed: false
                    }
                ]
            };
            renderAllTasks();
        }

        function renderAllTasks() {
            renderTaskCategory('podcast', tasksData.podcast, 'podcast-tasks', 'podcast-count');
            renderTaskCategory('discovery', tasksData.discovery, 'discovery-tasks', 'discovery-count');
            renderTaskCategory('strategy', tasksData.strategy, 'strategy-tasks', 'strategy-count');
            renderTaskCategory('client', tasksData.client, 'client-tasks', 'client-count');
        }

        function renderTaskCategory(category, tasks, containerId, countId) {
            const container = document.getElementById(containerId);
            const countEl = document.getElementById(countId);
            
            const incompleteTasks = tasks.filter(t => !t.completed);
            countEl.textContent = incompleteTasks.length;
            
            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-category">
                        ‚úÖ No ${category} tasks - all clear!
                    </div>
                `;
                return;
            }

            container.innerHTML = tasks.map(task => `
                <div class="task-item ${task.completed ? 'completed' : ''}" data-task-id="${task.id}">
                    <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask('${task.id}', '${category}')">
                        ${task.completed ? '‚úì' : ''}
                    </div>
                    <div class="task-content">
                        <div class="task-title">${task.title}</div>
                        <div class="task-details">${task.details}</div>
                        <div class="task-meta">
                            <span>üìÖ ${task.date}</span>
                            ${task.client ? `<span>üë§ ${task.client}</span>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleTask(taskId, category) {
            const categoryTasks = tasksData[category];
            const task = categoryTasks.find(t => t.id === taskId);
            
            if (task) {
                task.completed = !task.completed;
                
                // In production, save to database
                // await saveTaskStatus(taskId, task.completed);
                
                renderAllTasks();
                updateTaskBadge();
            }
        }

        function updateTaskBadge() {
            const totalIncomplete = 
                tasksData.podcast.filter(t => !t.completed).length +
                tasksData.discovery.filter(t => !t.completed).length +
                tasksData.strategy.filter(t => !t.completed).length +
                tasksData.client.filter(t => !t.completed).length;
            
            const badge = document.getElementById('tasks-badge');
            if (badge) {
                badge.textContent = totalIncomplete;
                badge.style.display = totalIncomplete > 0 ? 'block' : 'none';
            }
        }

        async function loadClients() {
            try {
                const response = await fetch(`${API_URL}/api/clients/active`);
                if (!response.ok) throw new Error('Failed to load clients');
                
                const result = await response.json();
                clientsData = result.clients || [];
                renderClientTabs();
            } catch (error) {
                console.error('[Sprints] Error loading clients:', error);
                loadDemoClients();
            }
        }

        function loadDemoClients() {
            clientsData = [
                {
                    id: 'c1',
                    name: 'Jonathan Brewer',
                    company: 'Brewer & Company',
                    stage: 'Discovery',
                    unreadCount: 3
                },
                {
                    id: 'c2',
                    name: 'Tye Shumway',
                    company: 'TWS Construction',
                    stage: 'Strategy',
                    unreadCount: 0
                },
                {
                    id: 'c3',
                    name: 'Sarah Johnson',
                    company: 'Design Co',
                    stage: 'Client',
                    unreadCount: 1
                }
            ];
            renderClientTabs();
        }

        function renderClientTabs() {
            const tabsContainer = document.getElementById('client-tabs');
            const contentsContainer = document.getElementById('client-contents');
            
            if (clientsData.length === 0) {
                tabsContainer.innerHTML = '<p style="padding: 1rem; color: #7f8c8d;">No active clients yet</p>';
                contentsContainer.innerHTML = '';
                return;
            }

            // Render tabs
            tabsContainer.innerHTML = clientsData.map((client, index) => `
                <button 
                    class="client-tab ${index === 0 ? 'active' : ''}" 
                    onclick="switchClient('${client.id}')"
                    data-client-id="${client.id}"
                >
                    ${client.name}
                    ${client.unreadCount > 0 ? `
                        <span class="client-tab-badge">${client.unreadCount}</span>
                        <span class="attention-indicator"></span>
                    ` : ''}
                </button>
            `).join('');

            // Render content areas
            contentsContainer.innerHTML = clientsData.map((client, index) => `
                <div class="client-content ${index === 0 ? 'active' : ''}" data-client-id="${client.id}">
                    <div class="client-info-bar">
                        <div class="client-info">
                            <div class="client-avatar">${client.name.split(' ').map(n => n[0]).join('')}</div>
                            <div class="client-details">
                                <h4>${client.name}</h4>
                                <p>${client.company}</p>
                            </div>
                        </div>
                        <div class="client-status">Stage: ${client.stage}</div>
                    </div>

                    <div class="message-thread" id="messages-${client.id}">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <p>Loading messages...</p>
                        </div>
                    </div>

                    <div class="message-input-container">
                        <textarea 
                            class="message-input" 
                            id="input-${client.id}"
                            placeholder="Type your message to ${client.name}..."
                        ></textarea>
                        <div class="message-actions">
                            <button class="btn btn-primary" onclick="sendMessage('${client.id}')">
                                üì§ Send
                            </button>
                            <button class="btn btn-icon" onclick="attachFile('${client.id}')" title="Attach File">
                                üìé
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            // Load messages for first client
            if (clientsData.length > 0) {
                activeClientId = clientsData[0].id;
                loadClientMessages(activeClientId);
            }
        }

        function switchClient(clientId) {
            // Update active tab
            document.querySelectorAll('.client-tab').forEach(tab => {
                if (tab.dataset.clientId === clientId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            // Update active content
            document.querySelectorAll('.client-content').forEach(content => {
                if (content.dataset.clientId === clientId) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });

            activeClientId = clientId;
            
            // Load messages if not already loaded
            if (!messagesData[clientId]) {
                loadClientMessages(clientId);
            }

            // Mark messages as read
            markMessagesRead(clientId);
        }

        async function loadMessages() {
            // Load messages for all clients
            for (const client of clientsData) {
                await loadClientMessages(client.id);
            }
        }

        async function loadClientMessages(clientId) {
            try {
                const response = await fetch(`${API_URL}/api/clients/${clientId}/messages`);
                if (!response.ok) throw new Error('Failed to load messages');
                
                const result = await response.json();
                messagesData[clientId] = result.messages || [];
                renderMessages(clientId);
            } catch (error) {
                console.error('[Sprints] Error loading messages:', error);
                loadDemoMessages(clientId);
            }
        }

        function loadDemoMessages(clientId) {
            const demoMessages = {
                'c1': [
                    {
                        id: 'm1',
                        from: 'client',
                        author: 'Jonathan',
                        text: 'Hey Maggie, here\'s our company logo and brand colors as requested!',
                        time: '2 hours ago',
                        attachments: [
                            { name: 'brewer-logo.png', type: 'image' },
                            { name: 'brand-guidelines.pdf', type: 'pdf' }
                        ]
                    },
                    {
                        id: 'm2',
                        from: 'you',
                        author: 'You',
                        text: 'Perfect! I\'ll incorporate these into your growth plan. Draft will be ready by Friday.',
                        time: '1 hour ago',
                        attachments: []
                    },
                    {
                        id: 'm3',
                        from: 'client',
                        author: 'Jonathan',
                        text: 'Great! Also, can we schedule our strategy call for next Tuesday afternoon?',
                        time: '30 minutes ago',
                        attachments: []
                    }
                ],
                'c2': [
                    {
                        id: 'm4',
                        from: 'you',
                        author: 'You',
                        text: 'Hi Tye! Your custom growth plan is attached. Let me know your thoughts!',
                        time: 'Yesterday',
                        attachments: [
                            { name: 'TWS-Growth-Plan.pdf', type: 'pdf' }
                        ]
                    },
                    {
                        id: 'm5',
                        from: 'client',
                        author: 'Tye',
                        text: 'This looks amazing, Maggie! Love the ROI projections. Let\'s discuss implementation on our call.',
                        time: '12 hours ago',
                        attachments: []
                    }
                ],
                'c3': [
                    {
                        id: 'm6',
                        from: 'client',
                        author: 'Sarah',
                        text: 'Quick question - can we adjust the timeline for phase 2 by a week?',
                        time: '3 hours ago',
                        attachments: []
                    }
                ]
            };

            messagesData[clientId] = demoMessages[clientId] || [];
            renderMessages(clientId);
        }

        function renderMessages(clientId) {
            const container = document.getElementById(`messages-${clientId}`);
            const messages = messagesData[clientId] || [];
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No messages yet. Start the conversation!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = messages.map(msg => `
                <div class="message from-${msg.from}">
                    <div class="message-avatar">${msg.author[0]}</div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-author">${msg.author}</span>
                            <span class="message-time">${msg.time}</span>
                        </div>
                        <div class="message-text">${msg.text}</div>
                        ${msg.attachments && msg.attachments.length > 0 ? `
                            <div class="message-attachments">
                                ${msg.attachments.map(att => `
                                    <div class="attachment" onclick="downloadAttachment('${att.name}')">
                                        <span>üìé</span>
                                        <span>${att.name}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        function sendMessage(clientId) {
            const input = document.getElementById(`input-${clientId}`);
            const text = input.value.trim();
            
            if (!text) {
                alert('Please enter a message');
                return;
            }

            // Add message to data
            if (!messagesData[clientId]) {
                messagesData[clientId] = [];
            }

            messagesData[clientId].push({
                id: 'm' + Date.now(),
                from: 'you',
                author: 'You',
                text: text,
                time: 'Just now',
                attachments: []
            });

            // Clear input
            input.value = '';

            // Re-render
            renderMessages(clientId);

            // In production: Save to database
            console.log('Sending message to', clientId, ':', text);
        }

        function attachFile(clientId) {
            // Trigger file input
            const input = document.getElementById('file-input');
            input.dataset.clientId = clientId;
            input.click();
        }

        function handleFileUpload() {
            const input = document.getElementById('file-input');
            const clientId = input.dataset.clientId;
            const files = input.files;
            
            if (files.length === 0) return;

            alert(`üì§ Uploading ${files[0].name} to ${clientsData.find(c => c.id === clientId)?.name}...`);
            
            // In production: Upload file and add to messages
            console.log('Uploading file to', clientId, ':', files[0].name);
            
            input.value = '';
        }

        function downloadAttachment(filename) {
            alert(`üì• Downloading ${filename}...`);
            console.log('Downloading:', filename);
        }

        function markMessagesRead(clientId) {
            const client = clientsData.find(c => c.id === clientId);
            if (client) {
                client.unreadCount = 0;
                renderClientTabs();
            }
        }

        function refreshTasks() {
            loadTasks();
        }

        function refreshMessages() {
            loadMessages();
        }

        function loadDemoData() {
            loadDemoTasks();
            loadDemoClients();
        }

        console.log('[Sprints] System initialized');
        console.log('[Sprints] API Endpoint:', API_URL);
    </script>
</body>
</html>
